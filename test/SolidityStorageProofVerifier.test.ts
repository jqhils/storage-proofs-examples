import { expect } from "chai";
import hre, { ethers } from "hardhat";

describe("StorageProofVerifier", function () {
  let StorageProofVerifier: any;
  let verifier: any;

  beforeEach(async function () {
    // Get contract factory
    StorageProofVerifier = await ethers.getContractFactory("StorageProofVerifier");

    // Deploy contract
    verifier = await StorageProofVerifier.deploy();
    await verifier.waitForDeployment();
  });

  it("should verify storage proof", async function () {
    // Block height 17000000
    const stateRoot = "0x72eea852168e4156811869d6e40789083891288161d5a110259cf4fc922b1a09";
    const account = "0xb47e3cd837dDF8e4c57F05d70Ab865de6e193BBB";
    const storageSlot = "0xdf7de25b7f1fd6d0b5205f0e18f1f35bd7b8d84cce336588d184533ce43a6f76";

    // Account proof
    const accountProof = [
      "0xf90211a0ac56e335724fb9576f47030b7f20271daf5af760471fab3ae53a17c2a96f27eda0d438f3ad8d96a3ad7e772738fe6518669e185352fddfd6b5f701c1bbbc4a4795a0b7502318f398fa0f9e138aa9f72b43f2a9d28bb1d422086d56c0e0a986de817fa07739d2fc7475e8fd330a7366ae160827b0e9ede670202aa02749323e91d4d22fa051811bb0263fac1357365af69ab11f523f80a028aab2c642cb793d3f78fd74e7a0bf4afc0e601fb4414472ad506eb12c744326412f03a72100676bb597f379f881a0ad0dd1675c4c7d15c5b7620a24502935b5e5627a2cc80a25579abf9ed7c1049da019c036d00e5ba00689c328391861f7f6251cbbd3d4ebb62ac5274406bd737cffa0f470a85d5192e60f03cdebffee9231cbe949e354e57e6eaeee0c7544d47edd81a00922c822cd85118b773a500a5dfdd9b8a38a604a9172b87c7b3471a65bbb8501a0d2fdf356ab6eca481a4027e1c576c24a75fcf1bfd12423eed0fd50a83f8e0d0aa016a3580e08047f0479c4be7b13bc7c5446f7e394d7a08ee413c352a2caf05fbea09bae005f7c383c1b26a142c19de08a9a38abf4264e1fbaf257423586dba918e8a06387d3eafc6b71bc47e5fe5a957637406636b41c1ddfbeb85352d5a11215cdffa0df6b96d4ec703253815f4d055358ce1ef7c820e00a58ba8694adad9f2db787daa0bc7b1ee96cfe4db5e0621777f634ec35d68cb2d3baff2911ae42fedb39274cab80",
      "0xf90211a0885f6898341f00858e7498c4785f1691d40c5fb6b048e9adec610e863c7de48ba0b5286b3e1c5db294f7226a2b691fb604342c9987b36ae93a5346425fe8f600faa0daefc7b3db7295b3879cbe472d621dc507387e08c0d3f73d969a774d4923488ca0e77a9aea93b5e3560846a8a4bf2d0f85c7c5b807751ee39c6125bc7ca17dd569a085871d306eb3c861f14c450665ece7d17874c4aa3c27fde61db4985c8ec70c0fa036e1a71fa4d26bf291dc2a631efff2402a7910c70cf0e90c8af34a6f19cda91fa04e9910acd9ec3ef584b871e27f5d6ef450522095938b9753c26782748b82c7cca04cf18124be5d427000d03bc09a2c952a85f4e6d5dd0d189ba9ef3474b3d3e929a0741c9301e2405b7c6981e4327d07543f3b1772c6adefbce3af171794b29b325ea0b9a2ed3a78b5e60118e7aee3ce8887d7db76cd1896a2c6ee487b97f8003d6f4ca0c435b3b06e880c9fc83f702f8c37bf93043ede88f2f4ca0e53d7c7d0e5b2cf8ba0b1d9548deba71d8560129d5e22995c0e1209465b73489e79b0a8d573a57e3f25a03694906c8d4f379c7a0f826d9929d5735190a1143b73b4ff78178eaf932dbd98a0f7618d28cdc9254e3115260bcfa33d7a2a709d755e567e526339f8610deeb1c3a0b0922739b6de67bdeb9fe59ddbc83522858e0b76b30f4b0828046733204fbb00a0d6d0c2b4e8e41f62bf2864e87b138b97b6c54bece8d5230790ded7934bc7002180",
      "0xf90211a0c8e84441e28356d8628a90935a100d8148de1d5d02371058c930b9b2dc89323ea062118275facea7692adb484b666927a4508c93faa412d22a8838894de6ba67a4a0f66cf9bed012bcfc0902feb53de7a6019107aba8c1568fd043d8592c2cf20aeea0a8cf1313dd600bd41edbc70710493b17403791d478598f601e1664131a83ed3ba0ed43ebcbe6ee1bbb7b690a55bd4ce6a2ee6dc6c31c17788d1664b7381e78922da0dfb301263ebfd124576e2b5b094e37728123c13e6317d655e154414503a8c8f2a0738d49ed7d629e5d58268aa3ed99cc81748174fb0ab97d7c4adbd47238c442ada01cdfc4e6976ca1db539d96d873a78a5bc52c148ced1b949100e9848e01ec31aaa01397a5ffcc8d892b6193c5abd832e44f1b51b28734fc6b3e31ee348b065c00eea00a823d596be2f577170b90b4cff641f9d6faea3a7e9fad37ca3866b2340dcf52a05197bccba96b95865970d9b97c356abaea3c5a8b267f2b0e4a3bea3162110eeba05ebf843973b93161e5d4cd698087d61080a946d102fe7389c2686c102b6e04d6a026edbdd5c09bb83b2039d72b7ee83522619238423bf962d9375eda9b90ca779aa04b65b75d60427a72ce20279b83cf2a727c91726fac0ac1061699f69c6e43efe3a01546f57716d55946a6a8b52316665c051134b39b52dd17efeb31ee4bc197794da0781ef6d5830cd89bbf2a5b1d89d8da148bfffa1effd231af4d3218df7431c6d280",
      "0xf90211a03d22b33d6fb9215b7fcd3f37a1635e12156e8a1cdcef56acdf7b13f14528a009a0d19750b6ac22b90634ea2196de05911e089beda4637a9642a9065fe2d88ac567a0d5d80d2b359cccb6dfdd5ed730ee39953e5561fab713206391474ef05d8830e7a087005aff12e99e08984e4b2bf4080e0544423d24e0d0209324476a8e93586036a09c9ea324fdf736080ad92aea6c4f4b9f159e06d0267d3bdeb8ee8840d4f46419a06ea7240f1af2731092335759662b46b115670009ae74dccbc1562e68c5fe9607a0ea676e1fa97aa7054e9681ed6d771e68f3bf25c5ff82ccfd2199e86d8b28818aa09c118a38c0000990e4d5f50b1fe7db09a80de85dad0bd57c9d32ba5a6b9471f1a039801ea78939420d347491955dc990523f2416aeb1746d0d384b30fdc338716aa07e47a567dd29b82e6ea7a011e76da76bbb3b69c197dfd53557e6e9735bac1669a0f6a3c98eeb1f4a3104b2664b188126a45fd35be60e09232f7ff547ba5be3f68ba0692167c9cf492de459324d9181ee1e03eef7d948208691fa05ff122ac2485013a0136e3e0dca6881395f4cbf5fbc11c872fb22f16f25acd5888c40aec132148f1aa03b18a33b2be567d8993f6dd635bc71411d6e82701f5bcecee9e5a6fff0b99510a075bb55403a3467d4699392e12f72d998cafc437a1f1e09a1fea450713b7cfa1fa07e3ff68fd6f9b62115167d65c9e7567deccb5500b9f8e370e109ecffa5daac0080",
      "0xf90211a0d5a8651881c4ea787e52d892215877d799d7e0c07101675106ce738f25e9dccba0e175324389271fca3a0ca038ebd2a3306dd26d7631bb5619a6de8082541774f6a0206ffc1cdad948702a451555f042ff77d10e1c225b7ec518960a0f5dc6dbdb44a0efa5b61d09ad49704f329313b947119703d0a2a28039d5508dea577ecfcb4434a00dab5ca531c74863902025e98168860cc66c541a85db69c589f80cf83221ccc4a02cdf19beafdc3407c3a4eac6d9a533366093dd1ab692cc9b327a98bb5aab8cb0a019e6db80fabc73b496439601b1476dc4f8fbf1fb3e87a4284a2754722444243da018486f497d1e942350b0260c50a6736aceccfba176460582e199416fb70d9c54a0884316679760dccc4d78e52875f494617e5d7f254b667127fe430a454e26b46ea00e876f53d668788529a8e32f8eeb7a32290d2f4e2513450021f780f70196cb9da0aa738442b56b7b7b0a7a4994b2869f9407477d5cde46c4dbea4dfda8c5f1e4d0a0991fbe6805676ee30b665e67ae100b6fd125405c9ac3ac9b8a145777e8bfada6a0c1df82411e4afea01b983acaf4086ecc10f06860655c47ca5dea0e918e521e6ca0d106f01bd0f5f9120e0eb3cf04f060e2d8cd1576edd65cd5e22c7812f2e70da4a020762e16717f18363ccb65e41e8a76c03a0d8675f190e5a995da82c42f59e2ffa048380272f56493ad1e055c4777cb4fb28108ab482ea981018a5d76bdfbd1483a80",
      "0xf90211a0a6904d92077058beb9c957088946db7de5e50789e714b890be0220826b32eb0ea012c1cc508cd8b2f4e3295c3d1bbacc86f1dccb446166502c2776225e4ee36c38a0fa8c7ab19235d09ec12d089a3ed309272ee818de99c5756abcac14269fe91fc5a0f023e13e8a8eb3504fe93c537cf75f6a501817bc97e80e7dcce52fe10e650f6fa00294c097e8e98c85c7a601f8412cc5c661dd373923b4b6ac4e5a7e05a8646bf6a07802c70a4db69d845f3d55c5586414581adb52d9a32c145ecb5487a291df6be2a03acee740dd3779c048b0a0eaad21d279af81479eac2355bc35086bfcbb294e40a0e2a65615401d9553eb8b4f420952c412325ba1f50266cf694602d36063c2acb4a0f72ce70fca3d8ce000e3f20bc9e82d6fd7059d6a42c80d71a0cd4eb2ef093bb5a0a1f5d50d54bcc9b5e7b9215edc239bc4dd01ec7201d0bca1e63d485bb09f4ddca0ca63b84f33fedf90b1d2f7607f2b3f2a26048de20b6e18d4c23809fcd6508821a02504d37801c2a28e3134947586bfa6ebe3820724eb16dee7f505941c6aa015f6a07549fa146ce97d39a62845e395d8f45840cea1b7f948deef25ab56e025709cd8a0c41c8caee8e3d9b30957b8c3432c79f1ec137d807b5b4fc70a5a6c5220f74642a02f20e595c6fa4f443ebf75b38ea4b10ca3666d748931dce34e836fc8b2549faba0bed85227306cce4fe4bee399e99a5f1586c68cc72fcd4b45351fabd465d39af280",
      "0xf901118080a0b561e85842111223038fd7ef285abf8af348d3f49fdb2a4a6a1976f0a0775069a0ea62ab5dbbac3e05268059e0d1a4815a143df0bf0f1ab7ba532a3a25420bfe0fa060e1c6c38ccdc96efaef7dbe161b9e612b4013014e5cc660a0b4cd224024e01f8080a094be361a9ee84da5a699b77e9c999dde4850a31a0dd019130a390613481c36e4a06b9e989cf29f77bc45584c8ad68b1f94c543baee8a1b0f110f528682817b0d9580a0fd09034e2321488f3370cf4f629bec6c28d786ffe7db4eb62e404ac3174e4629a07f63bab8bc1ebad904e5473ecbb4b8794b9e22a31e52b0f381b6d89018c44221a03e719b8a8c9fa923e3bfa639c832967256a3532ef23e4a307204510ca8c2cff180808080",
      "0xf8709d3f8c7fab57471a2a41387f9b0d0eab229457c5024bd6cfb72dd7bba2feb850f84e018a0132c428f6c2ac925d38a060ea0442239add8681004d895ce8171bf114b92ae1170859304a1976ab1caa4aa0e2e7a7524a98ce629ee406c15c51a683e4167f0b74ea230566ddece7ae9d6f0b"
    ];

    // Storage proof
    const storageProof = [
      "0xf90211a0a08045c62c4ac38d5817bb76640f44d523cf591ecd086173ca6f14c9de416e56a0a473a5a6e4b42ccbde34309dd6be4582745485aad7c1d4986a9564fd91dcf65ea0450b01eea4c3e15b33c686321522fd789d1aad5194185eb3a50563555a4e68b4a0528091fe30496aa5eadf2e05a84f8dda4062c857c71cd5dea4b691dbfdba7927a0a78b2edbc1c3aef02f28bc796132e3dc23637a245e4e9c4ec536e8a3f9d5103aa06fb4491ac8ee0631429fe617e20d0ae60733672d8bbb397d5601924dc8c4df9ea03729c42559700406b7f6ef79af92ab471363ef384b74eb14efd0f319d3def878a09ab529c205291b07437a9bed95b794e2117ce284ca2c360d38b2c81c4b1f9e22a0967382baf7636c15f4f33cd060225d20af4db5123b31c099ff7be76cfb4b865ca04e6b1b1f2b5cd5653f5753f8a313686754f877b420d15234fa9465db4cc2a07da05325b7f3bd094f7a1c78968bbee1deb8cee175e9f4a2f4d426dc2581d7195d35a0e506ffcf4e786beed4806abd542788ac954359eea37a585a95503b79f907ee01a051d69c4095a54124d8dfa749d5b4e6e6206ac193b0285d77d20d019f10707267a0d30f04314a5618926df650cfc261e299f15e2be9c00298ab96561afaeab34a9ca0af9d9c496d1a300cb6afd3adb5f183f76962ff6507e3153f4e299b3ae7de0f8da0a6f42bf9971483831ffd69b56b21532f5b63797a0099cc2073672e23fd0920e980",
      "0xf90211a081e4726f13b7e61068191118d02977bb40832b64f133778b5589a4a21a6e1ee5a07048b56fb891e74a6bc34ffd6e7dcfa425b0c54e3f5a686dc25d38d2efffd576a0d9db511b9739eaecd8b36579f2f9d01c63551a0e6982dc8b98c44966d196bbbca0f584dc0447a26bbff2cb2885ddf231dfd04e4998111e5afb824ff182fe580176a0685b687e16f82f2d4df3a484afe23e351d4f8cf571910000f220212f76e2112ba03445381c4a1de1b521f5b7d5b9776978c2636fca6f13eb618cb7c9c2bf62125ea09c9e173c592efcea9375c9f4a15757a5d9efc8596a436e31fbfad5a9da7a5ab0a0396aea2f72fb304d76ff874d983fb492b1b324eab85499559d91839dfcadb77ea0b1ad4811ee4ca9051701a46c512c96f679984252820c7f24e427b12a0b15d190a07ada3be05f07dec48e90bad24833f01b0ae655926db2d981ff41792c3080db28a0ac3f199aad4d4b893d085df3fa4c11b10822f1a7cbdd7aae463465f8c23d4911a08767c7a47f7677fc7378a91483502b5648f92332583de647e2d104d964245658a05835965df8c7b41475a6aef817ea59ed92d1f4a2561a6e0b34ce57a61468858da05dd9423e9c815afbbefd7a6a064fbc289df8d6c82b4c69f5b407609d37d15506a0f204caaa5149d85d8426271c472904dcd5195a28bc929d27b32c43c2a0570ddfa056088a5bcdc000be7f0dfdb5bea65b941b42051a19d9e82dc330fcd9799dc55180",
      "0xf90211a06e6c526bbae5fa941bbff21783bd0d8142e91757a8fb447fac447743e3f50882a036dbf81e2f1b4d9a926a810b968f39b2c4c94a5a957b6875ec7f468f90d2ff65a004076743565d0743455d52ea8c10416e4e845f90e84ca3cc1cf1b5c76cf448cfa0d4a6042b71d5f291839683b74c498d0217dc91e6429101523c3dbd34794ff902a0fcabe46fe8bf306209c208631bc70bb457483cdf22bf7366123ce6f486469b18a0e29314481265853f570994dfbda22bf5eee8edbee1594855fb96cc0bd6acc912a01a9804608a487fc5f7cc76cbdd9e7e1737453c1b106928aa34f73f6e8715af50a01b19654e62012f9ced096b9cb20ec9efdbf65b5044fccfb80902bf08089e6538a0311812188ead99ab045190e785aa15f62a00c8e23d9848dc0598ced98ec11920a0fcd6ff5f08b124243a6b6620bab9bc460d12f0fbe8a0285bc62fbcd2a0c0c87aa02e2b25e743da09dd13672d04ab0885b50299f474636652255c4e31a83e5b121ba0134f654eeb15660d24e9f9228353ee592a3ac74bb0984c71abaaab05694c60a0a01af50efcce72a1687a63df078f7249d2302a65c02018f9b735f6b4254b98b376a09470db48c723a372e17188491a81d768972e0fdb4cdefc23aed6b23cf2b2d18ea02c36e740d748308c56b1ec7bcbe6f55adc23c21ac7055df3c060cc227dc017d7a0ce5ec516f6af2f16d53c502dfa1614f2c51a78aa336fd8b0b286af16a53fdd4280",
      "0xf9011180a095f31b7ecadc65042ed2221d35429fa5230b9c7c78072b02de83458f6d2d721ca01b224a3512f2ff9dc2c18b488cb634ae2f8678f5cc4829f65de60da982495a1ca064d6cf7dc5e11b786fc02b7757a658f5e97f4ec28fb491533c80f0fb6739167c80a0602d298c7ddf18fea94ccec1e9f0c028bacab41e85059363af5eec9460f13bb98080a02625c5318347a0c87ba5086858633b8b0fe27b13fa474abc8bc9e1e71d84fa2ba05d76a252b28bd6a71ef6a625fd728880ba60f21fbbdaec41aadc0d259a9796bf808080a090717d4f4a1a4ca9e418a4e4bc844eea16f6ebfbbce07716672f94e8f9377f3a80a0f326a1f92059ff6679ccaf119531637a55d2e5669788efc30472e7360486414580",
      "0xf851808080808080808080808080a0e4392ab32e052e4922c1080b596e653ad3fd4c8a6337e582469bde245122350380a009202cf94dda6920304a933e33295e7cbfe9730370cf3d69809c9bddf3010f218080",
      "0xe09e3144cd35056e5b3aebd10c5e62566e9af1617088f92a0f803bf15715d84a02",
    ];

    // Call verifyStorageProof
    const [isValid, value] = await verifier.verifyStorageProof(
      stateRoot,
      account,
      storageSlot,
      accountProof,
      storageProof
    );

    // Log value
    console.log("Storage Value:", ethers.hexlify(value));

    // Assert proof validity
    expect(isValid).to.be.true;

    // Assert expected value
    const expectedValue = "0x02"
    expect(ethers.hexlify(value)).to.equal(expectedValue, "Storage value mismatch");

    // Perform test_verifyAccountState to measure gas
    await verifier.test_verifyStorageProof(
        stateRoot,
        account,
        storageSlot,
        accountProof,
        storageProof
    );
  });
});